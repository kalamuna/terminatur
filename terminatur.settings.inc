<?php

 /**
 * @file
 *  settings.inc: Helper functions to manipulate settings.php
 */

// Constants
define('TERMINATUR_VALIDATION_STRING', 'Terminatur: 1b f3 18 cd 6b 59 45 55 d1 ae');

/**
 * Validates the settings file
 */
function _terminatur_settings_validate($settings_file) {
  // Check for the terminatur signature
  $settings = file_get_contents($settings_file);
  if (strpos($settings, TERMINATUR_VALIDATION_STRING) !== false) {
    // Settings have been touched by the terminatur before
    // But let's verify they still work
    $databases = array();
    $drupal_6 = FALSE;
    // Get Drupal 6 stuff
    if (strpos($settings, "db_url") !== false) {
      $drupal_6 = TRUE;
      $db_url = '';
      $db_prefix = '';
    }
    // Load settings file
    require $settings_file;
    // Parse drupal 6
    if ($drupal_6) {
      $databases = _terminatur_data_parse_db_url($db_url, $db_prefix);
    }
    // Return false if there are no DB settings to be found
    if (!isset($databases)) {
      return FALSE;
    }
    return _terminatur_data_test_db_connection($databases);
  }
  return FALSE;
}

/**
 * Append local settings to a drupal settings file
 */
function _terminatur_settings_build($settings_file, &$databases) {
  if (!_terminatur_data_test_db_connection($databases)) {
    return FALSE;
  }
  // Determine drupal version
  $settings = file_get_contents($settings_file);
  $drupal_version = '7';
  if (strpos($settings, "db_url") !== false) {
    $drupal_version = '6';
  }

  $build_settings_func = '_terminatur_settings_build_' . $drupal_version;
  // Make sure the file is writable
  if (!chmod($settings_file, 0644)) {
    drush_log(dt("Settings file needs to be writable."), 'error');
  }
  $settings_file = $build_settings_func($settings_file, $databases);

  return _terminatur_settings_validate($settings_file);
}

/**
 * Helper file to append Drupal 6 style settings
 */
function _terminatur_settings_build_6($settings_file, &$databases) {
  // Open this way so we can append
  $fh = fopen($settings_file, 'a') or die("can't open file");
  $output = '';

  // Build the DB string
  $db_url = $databases['default']['default']['driver'] . '://' . $databases['default']['default']['username'] . ':' . $databases['default']['default']['password'] . '@' . $databases['default']['default']['host']. ':' . $databases['default']['default']['port'] . '/' . $databases['default']['default']['database'];

  // Generate the output
  $output .= "\n";
  $output .= "/** \n";
  $output .= " * " . TERMINATUR_VALIDATION_STRING . " \n";
  $output .= " * \n";
  $output .= " * These local settings were generated by terminatur. \n";
  $output .= " * You may see them if you use Kalastack, Kalabox, Proviso or other local dev tools. \n";
  $output .= " * \n";
  $output .= " */ \n";
  $output .=  TERMINATUR_SETTINGS_CONDITIONAL . " \n";
  $output .= "  // DB String \n";
  $output .= "  \$db_url = '" . $db_url .  "';\n";
  $output .= "}\n";
  $output .= "\n";

  $settings = $output;
  fwrite($fh, $settings);
  fclose($fh);

  return $settings_file;
}

/**
 * Helper file to append Drupal 7 style settings
 */
function _terminatur_settings_build_7($settings_file, &$databases) {
  // Open this way so we can append
  $fh = fopen($settings_file, 'a') or die("can't open file");
  $output = '';

  // Generate the output
  $output .= "\n";
  $output .= "/** \n";
  $output .= " * " . TERMINATUR_VALIDATION_STRING . " \n";
  $output .= " * \n";
  $output .= " * These local settings were generated by terminatur. \n";
  $output .= " * You may see them if you use Kalastack, Kalabox, Proviso or other local dev tools. \n";
  $output .= " * \n";
  $output .= " */ \n";
  $output .=  TERMINATUR_SETTINGS_CONDITIONAL . " \n";
  $output .= "  // DB Array and some common conf \n";
  $output .= "  \$databases['default']['default'] = array( \n";
  $output .= "    'driver' => '" . $databases['default']['default']['driver'] . "',\n";
  $output .= "    'database' => '" . $databases['default']['default']['database'] . "', \n";
  $output .= "    'username' => '" . $databases['default']['default']['username'] . "',\n";
  $output .= "    'password' => '" . $databases['default']['default']['password'] . "',\n";
  $output .= "    'host' => '" . $databases['default']['default']['host'] . "',\n";
  $output .= "    'port' => '" . $databases['default']['default']['port'] . "',\n";
  $output .= "    'prefix' => '',\n";
  $output .= "  );\n";
  $output .= "\n";
  $output .= "  // Set some common desirable local vars  \n";
  $output .= "  \$conf['file_temporary_path'] = '/tmp';\n";
  $output .= "  \$conf['file_public_path'] = 'sites/default/files';  \n";
  $output .= "  \$conf['file_private_path'] = 'sites/default/files/private';  \n";
  $output .= "  \$conf['reroute_email_enable'] = 1;  \n";
  $output .= "  \$conf['cache'] = 0;  \n";
  $output .= "  \$conf['css_gzip_compression'] = FALSE;  \n";
  $output .= "  \$conf['js_gzip_compression'] = FALSE;  \n";
  $output .= "}\n";

  $settings = $output;
  fwrite($fh, $settings);
  fclose($fh);

  return $settings_file;
}
